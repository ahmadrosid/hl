<table class="highlight-table">
<tbody>
<tr><td class="hl-num" data-line="1"></td><td><span class="hl-k">use</span> clap::{arg, App, AppSettings};</td></tr>
<tr><td class="hl-num" data-line="2"></td><td><span class="hl-k">mod</span> generator;</td></tr>
<tr><td class="hl-num" data-line="3"></td><td><span class="hl-k">mod</span> lexers;</td></tr>
<tr><td class="hl-num" data-line="4"></td><td><span class="hl-k">use</span> <span class="hl-k">crate</span>::lexers::{css, go, javascript, rust};</td></tr>
<tr><td class="hl-num" data-line="5"></td><td><span class="hl-k">use</span> std::fs::read;</td></tr>
<tr><td class="hl-num" data-line="6"></td><td><span class="hl-k">use</span> std::io::Write;</td></tr>
<tr><td class="hl-num" data-line="7"></td><td></td></tr>
<tr><td class="hl-num" data-line="8"></td><td><span class="hl-k">fn</span> <span class="hl-en">main</span>() {</td></tr>
<tr><td class="hl-num" data-line="9"></td><td>    <span class="hl-k">let</span> matches = App::<span class="hl-en">new</span>(<span class="hl-s">"hl"</span>)</td></tr>
<tr><td class="hl-num" data-line="10"></td><td>        .<span class="hl-en">version</span>(<span class="hl-s">"0.1.0"</span>)</td></tr>
<tr><td class="hl-num" data-line="11"></td><td>        .<span class="hl-en">author</span>(<span class="hl-s">"Ahmad Rosid &lt;alahmadrosid@gmail.com>"</span>)</td></tr>
<tr><td class="hl-num" data-line="12"></td><td>        .<span class="hl-en">about</span>(<span class="hl-s">"Syntax highlighting."</span>)</td></tr>
<tr><td class="hl-num" data-line="13"></td><td>        .<span class="hl-en">arg</span>(<span class="hl-en">arg</span>!([FILE_PATH] <span class="hl-s">"File path to parse."</span>))</td></tr>
<tr><td class="hl-num" data-line="14"></td><td>        .<span class="hl-en">arg</span>(<span class="hl-en">arg</span>!(lang: -l [LANG] <span class="hl-s">"Language."</span>))</td></tr>
<tr><td class="hl-num" data-line="15"></td><td>        .<span class="hl-en">subcommand</span>(</td></tr>
<tr><td class="hl-num" data-line="16"></td><td>            App::<span class="hl-en">new</span>(<span class="hl-s">"generate"</span>)</td></tr>
<tr><td class="hl-num" data-line="17"></td><td>                .<span class="hl-en">short_flag</span>('g')</td></tr>
<tr><td class="hl-num" data-line="18"></td><td>                .<span class="hl-en">long_flag</span>(<span class="hl-s">"generate"</span>)</td></tr>
<tr><td class="hl-num" data-line="19"></td><td>                .<span class="hl-en">about</span>(<span class="hl-s">"Generate lexer, this is for development only."</span>)</td></tr>
<tr><td class="hl-num" data-line="20"></td><td>                .<span class="hl-en">arg</span>(<span class="hl-en">arg</span>!([LEXER_PATH] <span class="hl-s">"Lexer path"</span>))</td></tr>
<tr><td class="hl-num" data-line="21"></td><td>                .<span class="hl-en">setting</span>(AppSettings::ArgRequiredElseHelp),</td></tr>
<tr><td class="hl-num" data-line="22"></td><td>        )</td></tr>
<tr><td class="hl-num" data-line="23"></td><td>        .<span class="hl-en">setting</span>(AppSettings::ArgRequiredElseHelp)</td></tr>
<tr><td class="hl-num" data-line="24"></td><td>        .<span class="hl-en">get_matches</span>();</td></tr>
<tr><td class="hl-num" data-line="25"></td><td></td></tr>
<tr><td class="hl-num" data-line="26"></td><td>    <span class="hl-k">let</span> <span class="hl-k">mut</span> lang = <span class="hl-s">""</span>;</td></tr>
<tr><td class="hl-num" data-line="27"></td><td>    <span class="hl-k">let</span> <span class="hl-k">mut</span> input: <span class="hl-k">Vec</span><<span class="hl-k">char</span>> = <span class="hl-k">vec</span>!['<span class="hl-c">0</span>'];</td></tr>
<tr><td class="hl-num" data-line="28"></td><td>    <span class="hl-k">match</span> matches.<span class="hl-en">subcommand</span>() {</td></tr>
<tr><td class="hl-num" data-line="29"></td><td>        <span class="hl-en">Some</span>((<span class="hl-s">"generate"</span>, sub_matches)) => {</td></tr>
<tr><td class="hl-num" data-line="30"></td><td>            <span class="hl-k">let</span> lexer_path = sub_matches.<span class="hl-en">value_of</span>(<span class="hl-s">"LEXER_PATH"</span>).<span class="hl-en">expect</span>(<span class="hl-s">"required"</span>);</td></tr>
<tr><td class="hl-num" data-line="31"></td><td>            <span class="hl-k">let</span> s = generator::<span class="hl-en">parse</span>(lexer_path);</td></tr>
<tr><td class="hl-num" data-line="32"></td><td>            <span class="hl-en">println</span>!(<span class="hl-s">"{}"</span>, s);</td></tr>
<tr><td class="hl-num" data-line="33"></td><td>            std::process::<span class="hl-en">exit</span>(<span class="hl-c">0</span>x<span class="hl-c">0</span><span class="hl-c">0</span><span class="hl-c">1</span>);</td></tr>
<tr><td class="hl-num" data-line="34"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="35"></td><td>        _ => {</td></tr>
<tr><td class="hl-num" data-line="36"></td><td>            <span class="hl-k">if</span> <span class="hl-k">let</span> <span class="hl-en">Some</span>(file) = matches.<span class="hl-en">value_of</span>(<span class="hl-s">"FILE_PATH"</span>) {</td></tr>
<tr><td class="hl-num" data-line="37"></td><td>                <span class="hl-k">let</span> source = <span class="hl-en">read</span>(file).<span class="hl-en">expect</span>(&<span class="hl-en">format</span>!(<span class="hl-s">"Filed reading file {}"</span>, file));</td></tr>
<tr><td class="hl-num" data-line="38"></td><td>                input = source.<span class="hl-en">iter</span>().<span class="hl-en">map</span>(|c| *c as <span class="hl-k">char</span>).<span class="hl-en">collect</span>::<<span class="hl-k">Vec</span><_>>();</td></tr>
<tr><td class="hl-num" data-line="39"></td><td>            }</td></tr>
<tr><td class="hl-num" data-line="40"></td><td>            <span class="hl-k">if</span> <span class="hl-k">let</span> <span class="hl-en">Some</span>(language) = matches.<span class="hl-en">value_of</span>(<span class="hl-s">"lang"</span>) {</td></tr>
<tr><td class="hl-num" data-line="41"></td><td>                lang = language;</td></tr>
<tr><td class="hl-num" data-line="42"></td><td>            }</td></tr>
<tr><td class="hl-num" data-line="43"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="44"></td><td>    }</td></tr>
<tr><td class="hl-num" data-line="45"></td><td></td></tr>
<tr><td class="hl-num" data-line="46"></td><td>    <span class="hl-k">match</span> lang {</td></tr>
<tr><td class="hl-num" data-line="47"></td><td>        <span class="hl-s">"go"</span> => {</td></tr>
<tr><td class="hl-num" data-line="48"></td><td>            <span class="hl-k">let</span> content = go::render::<span class="hl-en">render_html</span>(input);</td></tr>
<tr><td class="hl-num" data-line="49"></td><td>            <span class="hl-en">println</span>!(<span class="hl-s">"{}"</span>, content);</td></tr>
<tr><td class="hl-num" data-line="50"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="51"></td><td>        <span class="hl-s">"rust"</span> => {</td></tr>
<tr><td class="hl-num" data-line="52"></td><td>            <span class="hl-en">println</span>!(<span class="hl-s">"{}"</span>, rust::render::<span class="hl-en">render_html</span>(input));</td></tr>
<tr><td class="hl-num" data-line="53"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="54"></td><td>        <span class="hl-s">"css"</span> => {</td></tr>
<tr><td class="hl-num" data-line="55"></td><td>            <span class="hl-en">println</span>!(<span class="hl-s">"{}"</span>, css::render::<span class="hl-en">render_html</span>(input));</td></tr>
<tr><td class="hl-num" data-line="56"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="57"></td><td>        <span class="hl-s">"js"</span> => {</td></tr>
<tr><td class="hl-num" data-line="58"></td><td>            <span class="hl-en">println</span>!(<span class="hl-s">"{}"</span>, javascript::render::<span class="hl-en">render_html</span>(input));</td></tr>
<tr><td class="hl-num" data-line="59"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="60"></td><td>        _ => {</td></tr>
<tr><td class="hl-num" data-line="61"></td><td>            <span class="hl-en">println</span>!(<span class="hl-s">"Language {} not supported"</span>, lang);</td></tr>
<tr><td class="hl-num" data-line="62"></td><td>        }</td></tr>
<tr><td class="hl-num" data-line="63"></td><td>    }</td></tr>
<tr><td class="hl-num" data-line="64"></td><td>}</td></tr>
<tr><td class="hl-num" data-line="65"></td><td></td></tr>
<tr><td class="hl-num" data-line="66"></td><td><span class="hl-k">impl</span> Stream <span class="hl-k">for</span> RecursiveModuleLoad {</td></tr>
<tr><td class="hl-num" data-line="67"></td><td>  <span class="hl-k">type</span> Item = <span class="hl-k">Result</span><(ModuleRequest, ModuleSource), Error>;</td></tr>
<tr><td class="hl-num" data-line="68"></td><td></td></tr>
<tr><td class="hl-num" data-line="69"></td><td>  <span class="hl-k">fn</span> <span class="hl-en">poll_next</span>(</td></tr>
<tr><td class="hl-num" data-line="70"></td><td>    <span class="hl-c">self</span>: Pin<&<span class="hl-k">mut</span> <span class="hl-k">Self</span>>,</td></tr>
<tr><td class="hl-num" data-line="71"></td><td>    cx: &<span class="hl-k">mut</span> Context,</td></tr>
<tr><td class="hl-num" data-line="72"></td><td>  ) -> Poll<<span class="hl-k">Option</span><<span class="hl-k">Self</span>::Item>> {</td></tr>
<tr><td class="hl-num" data-line="73"></td><td>    <span class="hl-k">let</span> inner = <span class="hl-c">self</span>.<span class="hl-en">get_mut</span>();</td></tr>
<tr><td class="hl-num" data-line="74"></td><td>    <span class="hl-k">match</span> inner.<span class="hl-en">state</span> {</td></tr>
<tr><td class="hl-num" data-line="75"></td><td>      LoadState::Init => {</td></tr>
<tr><td class="hl-num" data-line="76"></td><td>        <span class="hl-k">let</span> module_specifier = <span class="hl-k">match</span> inner.<span class="hl-en">resolve_root</span>() {</td></tr>
<tr><td class="hl-num" data-line="77"></td><td>          <span class="hl-en">Ok</span>(url) => url,</td></tr>
<tr><td class="hl-num" data-line="78"></td><td>          <span class="hl-en">Err</span>(error) => <span class="hl-k">return</span> Poll::<span class="hl-en">Ready</span>(<span class="hl-en">Some</span>(<span class="hl-en">Err</span>(error))),</td></tr>
<tr><td class="hl-num" data-line="79"></td><td>        };</td></tr>
<tr><td class="hl-num" data-line="80"></td><td>        <span class="hl-k">let</span> load_fut = <span class="hl-k">if</span> <span class="hl-k">let</span> <span class="hl-en">Some</span>(_module_id) = inner.<span class="hl-en">root_module_id</span> {</td></tr>
<tr><td class="hl-num" data-line="81"></td><td>          <span class="hl-k">let</span> module_source = ModuleSource {</td></tr>
<tr><td class="hl-num" data-line="82"></td><td>            code: Default::<span class="hl-en">default</span>(),</td></tr>
<tr><td class="hl-num" data-line="83"></td><td>            module_type,</td></tr>
<tr><td class="hl-num" data-line="84"></td><td>          };</td></tr>
<tr><td class="hl-num" data-line="85"></td><td>        } <span class="hl-k">else</span> {</td></tr>
<tr><td class="hl-num" data-line="86"></td><td>          <span class="hl-k">let</span> maybe_referrer = <span class="hl-k">match</span> inner.<span class="hl-en">init</span> {</td></tr>
<tr><td class="hl-num" data-line="87"></td><td>            LoadInit::<span class="hl-en">DynamicImport</span>(_, <span class="hl-k">ref</span> referrer, _) => {</td></tr>
<tr><td class="hl-num" data-line="88"></td><td>              <span class="hl-en">resolve_url</span>(referrer).<span class="hl-en">ok</span>()</td></tr>
<tr><td class="hl-num" data-line="89"></td><td>            }</td></tr>
<tr><td class="hl-num" data-line="90"></td><td>            _ => <span class="hl-c">None</span>,</td></tr>
<tr><td class="hl-num" data-line="91"></td><td>          };</td></tr>
<tr><td class="hl-num" data-line="92"></td><td>          <span class="hl-k">match</span> inner.<span class="hl-en">pending</span>.<span class="hl-en">try_poll_next_unpin</span>(cx)? {</td></tr>
<tr><td class="hl-num" data-line="93"></td><td>            Poll::<span class="hl-en">Ready</span>(<span class="hl-c">None</span>) => <span class="hl-en">unreachable</span>!(),</td></tr>
<tr><td class="hl-num" data-line="94"></td><td>            Poll::<span class="hl-en">Ready</span>(<span class="hl-en">Some</span>(info)) => Poll::<span class="hl-en">Ready</span>(<span class="hl-en">Some</span>(<span class="hl-en">Ok</span>(info))),</td></tr>
<tr><td class="hl-num" data-line="95"></td><td>          }</td></tr>
<tr><td class="hl-num" data-line="96"></td><td>          <span class="hl-k">async</span> move {</td></tr>
<tr><td class="hl-num" data-line="97"></td><td>            <span class="hl-k">let</span> result = loader</td></tr>
<tr><td class="hl-num" data-line="98"></td><td>              .<span class="hl-en">load</span>(&module_specifier, maybe_referrer, is_dynamic_import)</td></tr>
<tr><td class="hl-num" data-line="99"></td><td>              .<span class="hl-k">await</span>;</td></tr>
<tr><td class="hl-num" data-line="100"></td><td>            result.<span class="hl-en">map</span>(|s| (module_request, s))</td></tr>
<tr><td class="hl-num" data-line="101"></td><td>          }</td></tr>
<tr><td class="hl-num" data-line="102"></td><td>          .<span class="hl-en">boxed_local</span>()</td></tr>
<tr><td class="hl-num" data-line="103"></td><td>        };</td></tr>
<tr><td class="hl-num" data-line="104"></td><td>      }</td></tr>
<tr><td class="hl-num" data-line="105"></td><td>    }</td></tr>
<tr><td class="hl-num" data-line="106"></td><td>  }</td></tr>
<tr><td class="hl-num" data-line="107"></td><td>}</td></tr>
<tr><td class="hl-num" data-line="108"></td><td></td></tr>
</tbody>
</table>